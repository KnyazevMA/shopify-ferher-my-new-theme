{%- comment -%}
  Очікувані параметри:
  - product           — обʼєкт продукту (опціонально, але краще явно)
  - option_index      — індекс опції (0, 1, 2...)
  - legend            — текст легенди (Color / Size)
  - mode              — 'color' або 'size'
{%- endcomment -%}

{%- liquid
  assign idx = option_index | default: -1

  if idx < 0
    echo '<!-- product-option-radio: invalid option_index -->'
  endif

  assign option = product.options_with_values[idx]
  assign opt_number = idx | plus: 1
  assign option_key = 'option' | append: opt_number
-%}

<fieldset class="product__option-{{ mode }} tw:border-none tw:p-0 tw:m-0 tw:mb-4">
  <legend class="product__legend tw:m-0 tw:mb-3">
    {{- legend -}}
  </legend>

  {%- if mode == 'color' -%}
    <div class="product__color-label-inner tw:flex tw:gap-2 tw:flex-row">
      {%- assign unique_colors = option.values | uniq -%}

      {%- for color_value in unique_colors limit: 3 -%}
        {%- assign has_available_for_color = false -%}
        {%- assign first_image_for_color = '' -%}

        {%- for v in product.variants -%}
          {%- assign v_color = v[option_key] -%}
          {%- if v_color and v_color == color_value -%}
            {%- if first_image_for_color == '' and v.featured_image -%}
              {%- assign first_image_for_color = v.featured_image | image_url: width: 800 -%}
            {%- endif -%}
            {%- if v.available -%}
              {%- assign has_available_for_color = true -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}

        <label class="custom-radio tw:cursor-pointer">
          <input
            class="custom-radio__field tw:peer tw:absolute tw:opacity-0 tw:size-0 tw:pointer-events-none"
            type="radio"
            name="color"
            value="{{ color_value }}"
            data-available="{{ has_available_for_color }}"
            data-image="{{ first_image_for_color }}"
            {% if forloop.first %}checked{% endif %}
            {% if form.errors and form.errors.color %}
              aria-invalid="true"
              aria-describedby="FieldError-Color-{{ product.id }}"
            {% endif %}
          >
          <span
            class="
              custom-radio__visual custom-radio__visual--color
              tw:size-8
              tw:flex tw:flex-wrap tw:justify-center tw:content-center
              tw:border-2 tw:border-black tw:rounded-full
              tw:p-4
              tw:peer-focus-visible:border-neutral-500
              tw:peer-focus-visible:opacity-80
              tw:peer-hover:border-neutral-500
              tw:peer-hover:opacity-80
              tw:peer-checked:border-neutral-500
              tw:peer-checked:opacity-70
            "
            style="background-color: {{ color_value | downcase }};"
          ></span>
        </label>
      {%- endfor -%}
    </div>

    {% if form.errors and form.errors.color %}
      <p
        id="FieldError-Color-{{ product.id }}"
        class="field-error"
        role="alert"
        aria-live="assertive"
      >
        {{ form.errors.color | join: ', ' }}
      </p>
    {% endif %}

  {%- elsif mode == 'size' -%}
    <div class="product__size-label-inner tw:grid tw:grid-cols-3 tw:gap-2 tw:w-full">
      {%- for size_value in option.values -%}
        {%- assign matched_variant_for_size = null -%}

        {%- for v in product.variants -%}
          {%- if v[option_key] == size_value -%}
            {%- assign matched_variant_for_size = v -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        <label class="custom-radio tw:cursor-pointer">
          <input
            class="custom-radio__field tw:peer tw:absolute tw:opacity-0 tw:size-0 tw:pointer-events-none"
            type="radio"
            name="size"
            value="{{ size_value }}"
            data-stock="{{ matched_variant_for_size.inventory_quantity }}"
            data-available="{{ matched_variant_for_size.available }}"
            {% if forloop.first %}checked{% endif %}
            {% if form.errors and form.errors.size %}
              aria-invalid="true"
              aria-describedby="FieldError-Size-{{ product.id }}"
            {% endif %}
          >
          <span
            class="
              custom-radio__visual
              tw:flex tw:flex-wrap tw:justify-center tw:content-center
              tw:border tw:border-gray-300 tw:rounded-lg
              tw:p-4
              tw:peer-focus-visible:border-black
              tw:peer-hover:border-black
              tw:peer-checked:border-black
            "
          >
            {{- size_value -}}
          </span>
        </label>
      {%- endfor -%}
    </div>

    {% if form.errors and form.errors.size %}
      <p
        id="FieldError-Size-{{ product.id }}"
        class="field-error"
        role="alert"
        aria-live="assertive"
      >
        {{ form.errors.size | join: ', ' }}
      </p>
    {% endif %}
  {%- endif -%}
</fieldset>
