{% liquid
  assign current_variant = product.selected_or_first_available_variant
  assign color_option_index = -1
  assign size_option_index = -1

  for option in product.options_with_values
    assign dn = option.name | downcase

    if dn contains 'color' or dn contains 'colour' or dn contains 'колір'
      assign color_option_index = forloop.index0
    endif

    if dn contains 'size' or dn contains 'розмір'
      assign size_option_index = forloop.index0
    endif
  endfor
%}

<section class="product" data-product-id="{{ product.id }}">
  <div class="page-width">
    {% if product %}
      <div
        class="
          product__wrapper
          tw:grid tw:grid-cols-2 tw:gap-15
        "
      >
        <div
          class="
            product__inner-left
            tw:flex tw:flex-row-reverse tw:gap-6
          "
        >
          <div
            class="
              product__wrapper-big-img
              tw:relative tw:aspect-square tw:max-w-full tw:h-auto tw:rounded-lg tw:overflow-hidden tw:max-h-[536px]
            "
          >
            {% if product.featured_image %}
              {{
                product.featured_image
                | image_url: width: 536
                | image_tag: class: 'product__main-img tw:block tw:h-full tw:w-full tw:object-cover', alt: product.title
              }}
            {% else %}
              {{ 'image' | placeholder_svg_tag: 'product__placeholder' }}
            {% endif %}
          </div>

          {% if section.settings.show_thumbnails %}
            <div class="product__thumb-group-list" data-thumbs>
              {%- if color_option_index >= 0 -%}
                {%- assign color_option = product.options_with_values[color_option_index] -%}
                {%- assign colors = color_option.values | uniq -%}

                {%- for color_value in colors -%}
                  <div
                    class="
                      product__thumb-group
                      tw:flex tw:flex-col tw:gap-6
                    "
                    data-color="{{ color_value | downcase }}"
                    {% unless forloop.first %}
                      tw:hidden
                    {% endunless %}
                  >
                    {%- assign count = 0 -%}
                    {%- assign opt_number = color_option_index | plus: 1 -%}
                    {%- assign option_key = 'option' | append: opt_number -%}

                    {%- for v in product.variants -%}
                      {%- assign v_color = v[option_key] -%}
                      {%- if v_color and v_color == color_value and v.featured_image -%}
                        <button
                          class="
                            product__btn-img {% if count == 0 %}product__btn-img--active{% endif %}
                            tw:p-0 tw:w-[88px] tw:h-[88px] tw:bg-transparent tw:rounded-lg tw:cursor-pointer tw:overflow-hidden tw:relative tw:flex-none
                            tw:hover:border tw:hover:border-black/30 tw:focus-visible:border tw:focus-visible:border-black/30 tw:focus-visible:outline-none
                          "
                          type="button"
                          data-large="{{ v.featured_image | image_url: width: 800 }}"
                        >
                          {{ v.featured_image | image_url: width: 88 | image_tag: alt: color_value }}
                        </button>
                        {%- assign count = count | plus: 1 -%}
                        {%- if count >= 5 -%}{% break %}{%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}

                    {%- if count == 0 -%}
                      {{ 'image' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                {%- endfor -%}

              {%- else -%}
                <div class="product__thumb-group tw:flex tw:flex-col tw:gap-6" data-color="all">
                  {%- assign shown = 0 -%}
                  {%- for m in product.media limit: 5 -%}
                    {%- if m.media_type == 'image' -%}
                      <button
                        class="
                          product__btn-img {% if shown == 0 %}product__btn-img--active{% endif %}
                          tw:p-0 tw:w-[88px] tw:h-[88px] tw:bg-transparent tw:rounded-lg tw:cursor-pointer tw:overflow-hidden tw:relative tw:flex-none
                          tw:hover:border tw:hover:border-black/30 tw:focus-visible:border tw:focus-visible:border-black/30 tw:focus-visible:outline-none
                        "
                        type="button"
                        data-large="{{ m | image_url: width: 800 }}"
                      >
                        {{ m | image_url: width: 88 | image_tag: alt: product.title }}
                      </button>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              {%- endif -%}
            </div>
          {% endif %}
        </div>

        <div class="product__inner-right">
          <h1 class="product__title tw:mb-3">{{ product.title }}</h1>



          <div class="jdgm-widget jdgm-preview-badge" data-id="{{ product.id }}"></div>

          {%- form 'product', product, id: 'ProductForm', class: 'product__form' -%}
            <div class="product__wrapper-top tw:flex tw:justify-between tw:max-w-3/4 tw:gap-2.5">
              <div class="product__inner-top tw:flex tw:flex-col tw:gap-3.5">
                <p class="product__price tw:block tw:m-0 tw:text-slate-500">
                  {% if current_variant.compare_at_price and current_variant.compare_at_price > current_variant.price %}
                    <span id="ProductPrice" class="product__price--sale">
                      {{ current_variant.price | money }}
                    </span>
                    <span id="ProductCompare" class="product__price--old">
                      {{ current_variant.compare_at_price | money }}
                    </span>
                  {% else %}
                    <span id="ProductPrice">{{ current_variant.price | money }}</span>
                    <span id="ProductCompare" hidden></span>
                  {% endif %}
                </p>

                <span class="product__availability tw:m-0 tw:mb-3" id="variant-availability"> </span>
              </div>
              <div class="product__quantily tw:flex tw:flex-col tw:items-center tw:gap-2.5">
                <div class="product__quantity-label tw:inline-flex tw:items-center tw:gap-2 tw:relative">
                  <label
                    for="Quantity-{{ product.id }}"
                    class="product__quantity-label-text tw:text-sm tw:font-semibold"
                  >
                    {{- 'products.product.quantity' | t: default: 'Quantity' -}}
                  </label>
                  <button
                    type="button"
                    class="product__quantity-info tw:inline-flex tw:items-center tw:justify-center tw:size-5 tw:p-0 tw:border-none tw:bg-transparent tw:cursor-pointer"
                    aria-label="{{ 'products.product.quantity_help' | t: default: 'Enter desired quantity to add to cart.' }}"
                    aria-describedby="QuantityHelp-{{ product.id }}"
                  >
                    <svg class="icon icon--info" width="16" height="16" focusable="false">
                      <use href="#icon-info"></use>
                    </svg>
                  </button>
                  <span id="QuantityHelp-{{ product.id }}" class="tooltip tooltip--above" role="tooltip">
                    {{- 'products.product.quantity_help' | t: default: 'Enter desired quantity to add to cart.' -}}
                  </span>
                </div>
                {% render 'quantity' %}
              </div>
            </div>

            {% if form.errors %}
              <div class="form-errors" role="alert" aria-live="assertive">
                {{ form.errors | default_errors }}
              </div>
            {% endif %}
            {% if form.posted_successfully? %}
              <div class="form-success" role="status" aria-live="polite">
                {{ 'products.product.added_success' | t }}
              </div>
            {% endif %}

            {%- if color_option_index >= 0 -%}
              {% render 'product-option-radio',
                product: product,
                option_index: color_option_index,
                legend: section.settings.color_text_title,
                mode: 'color'
              %}
            {%- endif -%}

            {%- if size_option_index >= 0 -%}
              {% render 'product-option-radio',
                product: product,
                option_index: size_option_index,
                legend: section.settings.size_text_title,
                mode: 'size'
              %}
            {%- endif -%}

            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

            <div
              class="hp-field"
              aria-hidden="true"
              style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"
            >
              <label class="sr-only" for="hp-{{ product.id }}">
                {{- 'forms.honeypot' | t: default: 'Leave this field empty' -}}
              </label>
              <input id="hp-{{ product.id }}" type="text" name="hp" tabindex="-1" autocomplete="off">
            </div>

            {% if form.errors and form.errors.quantity %}
              <p id="FieldError-Quantity-{{ product.id }}" class="field-error" role="alert" aria-live="assertive">
                {{ form.errors.quantity | join: ', ' }}
              </p>
            {% endif %}

            <div class="product__btn-wrap">
              <button
                class="
                  product__btn
                  tw:m-0 tw:mb-8 tw:relative tw:p-4 tw:w-full
                  tw:bg-black tw:text-white
                  tw:border-none tw:rounded-lg tw:cursor-pointer
                  tw:disabled:opacity-50 tw:disabled:cursor-not-allowed
                  tw:hover:bg-neutral-500
                "
                type="submit"
                {% unless current_variant.available %}
                  disabled
                {% endunless %}
              >
                {% if current_variant.available %}
                  {{ 'products.product.add_to_cart' | t }}
                {% else %}
                  {{ 'products.product.sold_out' | t }}
                {% endif %}
              </button>
            </div>
          {%- endform -%}

          <p class="product__description tw:m-0 tw:text-slate-500">
            {{ product.description | strip_html | truncate: 300 }}
          </p>
        </div>
      </div>
    {% else %}
      <p>Product object is missing in this context.</p>
    {% endif %}
  </div>
</section>

<script type="application/json" id="ProductVariants-{{ product.id }}">
  {
    {%- for v in product.variants -%}
      "{{ v.id }}": {
        "id": {{ v.id | json }},
        "available": {{ v.available | json }},
        "inventory_quantity": {{ v.inventory_quantity | default: 0 | json }},
        "option1": {{ v.option1 | json }},
        "option2": {{ v.option2 | json }},
        "inventory_management": {{ v.inventory_management | json }},
        "inventory_policy": {{ v.inventory_policy | json }},
        "featured_image": {{ v.featured_image | image_url: width: 800 | json }},
        "price_money": {{ v.price | money | json }},
        "compare_money": {{ v.compare_at_price | money | json }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  }
</script>

<script type="application/json" id="Translations">
  {
    "in_stock": {{ 'products.product.in_stock' | t: default: 'In stock: ' | json }},
    "sold_out": {{ 'products.product.sold_out' | t: default: 'Sold out' | json }},
    "in_stock_generic": {{ 'products.product.in_stock_generic' | t: default: 'In stock' | json }},
    "quantity_min_error": {{ 'products.product.quantity_min_error' | t: default: 'Quantity must be at least 1' | json }},
    "productId": {{ product.id | json }},
    "locale": {{ request.locale.iso_code | default: shop.locale | json }},
    "added_short": {{ 'products.product.added_short' | t: default: 'Added!' | json }},
    "error_short": {{ 'general.error_short' | t: default: 'Error' | json }},
    "added_to_cart": {{ 'products.product.added_to_cart' | t: default: 'Added to cart' | json }},
    "missing_product_id": {{ 'cart.missing_product_id' | t: default: 'Missing product id' | json }},
    "add_to_cart_failed": {{ 'cart.add_to_cart_failed' | t: default: 'Add to cart failed' | json }},
    "error_adding_to_cart": {{ 'cart.error_adding_to_cart' | t: default: 'Error adding to cart' | json }}
  }
</script>

{%- style -%}
  .product {
    margin-bottom: {{ section.settings.bottom_margin | default: 0 }}px;
  }
{%- endstyle -%}

{% schema %}
{
  "name": "Main product (adapted)",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show thumbnails",
      "default": true
    },
    {
      "type": "text",
      "id": "color_text_title",
      "label": "Color label text",
      "default": "Виберіть колір:"
    },
    {
      "type": "text",
      "id": "size_text_title",
      "label": "Size label text",
      "default": "Виберіть розмір:"
    },
    {
      "type": "range",
      "id": "bottom_margin",
      "label": "Відступ знизу (px)",
      "min": 0,
      "max": 120,
      "step": 5,
      "default": 40
    }
  ]
}
{% endschema %}
