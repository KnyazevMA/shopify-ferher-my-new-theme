{% assign current_variant = product.selected_or_first_available_variant %}

<section class="product" data-product-id="{{ product.id }}">
  <div class="page-width">
    {% if product %}
      <div class="product__wrapper">
        <div class="product__inner-left">
          <div class="product__wrapper-big-img">
            {% if product.featured_image %}
              {{
                product.featured_image
                | image_url: width: 536
                | image_tag: class: 'product__main-img', alt: product.title
              }}
            {% else %}
              {{ 'image' | placeholder_svg_tag: 'product__placeholder' }}
            {% endif %}
          </div>

          {% if section.settings.show_thumbnails %}
            <div class="product__thumb-group-list" data-thumbs>
              {%- assign color_option_index = -1 -%}
              {%- for option in product.options_with_values -%}
                {%- assign dn = option.name | downcase -%}
                {%- if dn contains 'color' or dn contains 'colour' or dn contains 'колір' -%}
                  {%- assign color_option_index = forloop.index0 -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if color_option_index >= 0 -%}
                {%- assign color_option = product.options_with_values[color_option_index] -%}
                {%- assign colors = color_option.values | uniq -%}

                {%- for color_value in colors -%}
                  <div
                    class="product__thumb-group"
                    data-color="{{ color_value | downcase }}"
                    {% unless forloop.first %}
                      style="display:none"
                    {% endunless %}
                  >
                    {%- assign count = 0 -%}
                    {%- assign opt_number = color_option_index | plus: 1 -%}
                    {%- assign option_key = 'option' | append: opt_number -%}

                    {%- for v in product.variants -%}
                      {%- assign v_color = v[option_key] -%}
                      {%- if v_color and v_color == color_value and v.featured_image -%}
                        <button
                          class="product__btn-img {% if count == 0 %}product__btn-img--active{% endif %}"
                          type="button"
                          data-large="{{ v.featured_image | image_url: width: 800 }}"
                        >
                          {{ v.featured_image | image_url: width: 88 | image_tag: alt: color_value }}
                        </button>
                        {%- assign count = count | plus: 1 -%}
                        {%- if count >= 5 -%}{% break %}{%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}

                    {%- if count == 0 -%}
                      {{ 'image' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                {%- endfor -%}

              {%- else -%}
                <div class="product__thumb-group" data-color="all">
                  {%- assign shown = 0 -%}
                  {%- for m in product.media limit: 5 -%}
                    {%- if m.media_type == 'image' -%}
                      <button
                        class="product__btn-img {% if shown == 0 %}product__btn-img--active{% endif %}"
                        type="button"
                        data-large="{{ m | image_url: width: 800 }}"
                      >
                        {{ m | image_url: width: 88 | image_tag: alt: product.title }}
                      </button>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              {%- endif -%}
            </div>
          {% endif %}
        </div>

        <div class="product__inner-right">
          <h1 class="product__title">{{ product.title }}</h1>

          {%- form 'product', product, id: 'ProductForm', class: 'product__form' -%}
            <div class="product__wrapper-top">
              <div class="product__inner-top">
                <p class="product__price">
                  {% if current_variant.compare_at_price and current_variant.compare_at_price > current_variant.price %}
                    <span id="ProductPrice" class="product__price--sale">
                      {{ current_variant.price | money }}
                    </span>
                    <span id="ProductCompare" class="product__price--old">
                      {{ current_variant.compare_at_price | money }}
                    </span>
                  {% else %}
                    <span id="ProductPrice">{{ current_variant.price | money }}</span>
                    <span id="ProductCompare" hidden></span>
                  {% endif %}
                </p>

                <span class="product__availability" id="variant-availability"> </span>
              </div>
              <div class="product__quantily">
                <div class="product__quantity-label">
                  <label for="Quantity-{{ product.id }}" class="product__quantity-label-text">
                    {{- 'products.product.quantity' | t: default: 'Quantity' -}}
                  </label>
                  <button
                    type="button"
                    class="product__quantity-info"
                    aria-label="{{ 'products.product.quantity_help' | t: default: 'Enter desired quantity to add to cart.' }}"
                    aria-describedby="QuantityHelp-{{ product.id }}"
                  >
                    <svg class="icon icon--info" width="16" height="16" focusable="false">
                      <use href="#icon-info"></use>
                    </svg>
                  </button>
                  <span id="QuantityHelp-{{ product.id }}" class="tooltip tooltip--above" role="tooltip">
                    {{- 'products.product.quantity_help' | t: default: 'Enter desired quantity to add to cart.' -}}
                  </span>
                </div>
                {% render 'quantity' %}
              </div>
            </div>

            {% if form.errors %}
              <div class="form-errors" role="alert" aria-live="assertive">
                {{ form.errors | default_errors }}
              </div>
            {% endif %}
            {% if form.posted_successfully? %}
              <div class="form-success" role="status" aria-live="polite">
                {{ 'products.product.added_success' | t }}
              </div>
            {% endif %}

            {% assign color_option_index = -1 %}

            {%- for option in product.options_with_values -%}
              {%- assign downcase_name = option.name | downcase -%}
              {%- if downcase_name contains 'color'
                or downcase_name contains 'colour'
                or downcase_name contains 'колір'
              -%}
                {%- assign color_option_index = forloop.index0 -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if color_option_index >= 0 -%}
              <fieldset class="product__option-color">
                <legend class="product__legend">{{ section.settings.color_text_title }}</legend>
                <div class="product__color-label-inner">
                  {%- assign color_option = product.options_with_values[color_option_index] -%}
                  {%- assign unique_colors = color_option.values | uniq -%}

                  {%- assign color_opt_number = color_option_index | plus: 1 -%}
                  {%- assign color_option_key = 'option' | append: color_opt_number -%}

                  {%- for color_value in unique_colors limit: 3 -%}
                    {%- assign has_available_for_color = false -%}
                    {%- assign first_image_for_color = '' -%}
                    {%- for v in product.variants -%}
                      {%- assign v_color = v[color_option_key] -%}
                      {%- if v_color and v_color == color_value -%}
                        {%- if first_image_for_color == '' and v.featured_image -%}
                          {%- assign first_image_for_color = v.featured_image | image_url: width: 800 -%}
                        {%- endif -%}
                        {%- if v.available -%}
                          {%- assign has_available_for_color = true -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    <label class="custom-radio">
                      <input
                        class="custom-radio__field"
                        type="radio"
                        name="color"
                        value="{{ color_value }}"
                        data-available="{{ has_available_for_color }}"
                        data-image="{{ first_image_for_color }}"
                        {% if forloop.first %}
                          checked
                        {% endif %}
                        {% if form.errors and form.errors.color %}
                          aria-invalid="true"
                          aria-describedby="FieldError-Color-{{ product.id }}"
                        {% endif %}
                      >
                      <span
                        class="custom-radio__visual custom-radio__visual--color"
                        style="background-color: {{ color_value | downcase }};"
                      ></span>
                    </label>
                  {%- endfor -%}
                </div>

                {% if form.errors and form.errors.color %}
                  <p
                    id="FieldError-Color-{{ product.id }}"
                    class="field-error"
                    role="alert"
                    aria-live="assertive"
                  >
                    {{ form.errors.color | join: ', ' }}
                  </p>
                {% endif %}
              </fieldset>
            {%- endif -%}

            {% assign size_option_index = -1 %}

            {%- for option in product.options_with_values -%}
              {%- assign downcase_name = option.name | downcase -%}
              {%- if downcase_name contains 'size' or downcase_name contains 'розмір' -%}
                {%- assign size_option_index = forloop.index0 -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if size_option_index >= 0 -%}
              <fieldset class="product__option-size">
                <legend class="product__legend">{{ section.settings.size_text_title }}</legend>
                <div class="product__size-label-inner">
                  {%- assign size_option = product.options_with_values[size_option_index] -%}
                  {%- assign size_opt_number = size_option_index | plus: 1 -%}
                  {%- assign size_option_key = 'option' | append: size_opt_number -%}
                  {%- for size_value in size_option.values -%}
                    {%- assign matched_variant_for_size = null -%}
                    {%- for v in product.variants -%}
                      {%- if v[size_option_key] == size_value -%}
                        {%- assign matched_variant_for_size = v -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                    <label class="custom-radio">
                      <input
                        class="custom-radio__field"
                        type="radio"
                        name="size"
                        value="{{ size_value }}"
                        data-stock="{{ matched_variant_for_size.inventory_quantity }}"
                        data-available="{{ matched_variant_for_size.available }}"
                        {% if forloop.first %}
                          checked
                        {% endif %}
                        {% if form.errors and form.errors.size %}
                          aria-invalid="true"
                          aria-describedby="FieldError-Size-{{ product.id }}"
                        {% endif %}
                      >
                      <span class="custom-radio__visual">{{ size_value }}</span>
                    </label>
                  {%- endfor -%}
                </div>
                {% if form.errors and form.errors.size %}
                  <p
                    id="FieldError-Size-{{ product.id }}"
                    class="field-error"
                    role="alert"
                    aria-live="assertive"
                  >
                    {{ form.errors.size | join: ', ' }}
                  </p>
                {% endif %}
              </fieldset>
            {%- endif -%}

            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

            <div
              class="hp-field"
              aria-hidden="true"
              style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"
            >
              <label class="sr-only" for="hp-{{ product.id }}">
                {{- 'forms.honeypot' | t: default: 'Leave this field empty' -}}
              </label>
              <input id="hp-{{ product.id }}" type="text" name="hp" tabindex="-1" autocomplete="off">
            </div>

            {% if form.errors and form.errors.quantity %}
              <p id="FieldError-Quantity-{{ product.id }}" class="field-error" role="alert" aria-live="assertive">
                {{ form.errors.quantity | join: ', ' }}
              </p>
            {% endif %}

            <fieldset class="product__props">
              <legend class="product__legend">
                {{ 'products.product.inquiry_title' | t: default: 'Product inquiry' }}
              </legend>
              <label for="PropContact-{{ product.id }}">
                {{- 'products.product.preferred_contact' | t: default: 'Preferred contact method' -}}
              </label>
              <select
                class="product__select"
                id="PropContact-{{ product.id }}"
                name="properties[Preferred contact]"
                {% if form.errors and form.errors['properties[Preferred contact]'] %}
                  aria-invalid="true" aria-describedby="FieldError-PropContact-{{ product.id }}"
                {% endif %}
              >
                <option value="email">{{ 'products.product.contact_email' | t: default: 'Email' }}</option>
                <option value="phone">{{ 'products.product.contact_phone' | t: default: 'Phone' }}</option>
              </select>
              {% if form.errors and form.errors['properties[Preferred contact]'] %}
                <p id="FieldError-PropContact-{{ product.id }}" class="field-error" role="alert" aria-live="assertive">
                  {{ form.errors['properties[Preferred contact]'] | join: ', ' }}
                </p>
              {% endif %}
              <label for="PropReason-{{ product.id }}">{{ 'products.product.reason' | t: default: 'Reason' }}</label>
              <textarea
                id="PropReason-{{ product.id }}"
                name="properties[Reason]"
                class="product__textarea"
                rows="3"
                maxlength="300"
                autocomplete="off"
                style="resize: none;"
                {% if form.errors and form.errors['properties[Reason]'] %}
                  aria-invalid="true" aria-describedby="FieldError-PropReason-{{ product.id }}"
                {% endif %}
              ></textarea>
              {% if form.errors and form.errors['properties[Reason]'] %}
                <p id="FieldError-PropReason-{{ product.id }}" class="field-error" role="alert" aria-live="assertive">
                  {{ form.errors['properties[Reason]'] | join: ', ' }}
                </p>
              {% endif %}
            </fieldset>

            <div class="product__btn-wrap">
              <button
                class="product__btn"
                type="submit"
                {% unless current_variant.available %}
                  disabled
                {% endunless %}
              >
                {% if current_variant.available %}
                  {{ 'products.product.add_to_cart' | t }}
                {% else %}
                  {{ 'products.product.sold_out' | t }}
                {% endif %}
              </button>
            </div>
          {%- endform -%}

          <p class="product__description">
            {{ product.description | strip_html | truncate: 300 }}
          </p>
        </div>
      </div>

      <script type="application/json" id="ProductVariants-{{ product.id }}">
        {
          {%- for v in product.variants -%}
            "{{ v.id }}": {
              "id": {{ v.id | json }},
              "available": {{ v.available | json }},
              "inventory_quantity": {{ v.inventory_quantity | default: 0 | json }},
              "option1": {{ v.option1 | json }},
              "option2": {{ v.option2 | json }},
              "inventory_management": {{ v.inventory_management | json }},
              "inventory_policy": {{ v.inventory_policy | json }},
              "featured_image": {{ v.featured_image | image_url: width: 800 | json }},
              "price_money": {{ v.price | money | json }},
              "compare_money": {{ v.compare_at_price | money | json }}
            }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        }
      </script>

      <script type="application/json" id="Translations">
        {
          "in_stock": {{ 'products.product.in_stock' | t: default: 'In stock: ' | json }},
          "sold_out": {{ 'products.product.sold_out' | t: default: 'Sold out' | json }},
          "in_stock_generic": {{ 'products.product.in_stock_generic' | t: default: 'In stock' | json }},
          "quantity_min_error": {{ 'products.product.quantity_min_error' | t: default: 'Quantity must be at least 1' | json }},
          "productId": {{ product.id | json }},
          "locale": {{ request.locale.iso_code | default: shop.locale | json }},
          "added_short": {{ 'products.product.added_short' | t: default: 'Added!' | json }},
          "error_short": {{ 'general.error_short' | t: default: 'Error' | json }},
          "added_to_cart": {{ 'products.product.added_to_cart' | t: default: 'Added to cart' | json }},
          "missing_product_id": {{ 'cart.missing_product_id' | t: default: 'Missing product id' | json }},
          "add_to_cart_failed": {{ 'cart.add_to_cart_failed' | t: default: 'Add to cart failed' | json }},
          "error_adding_to_cart": {{ 'cart.error_adding_to_cart' | t: default: 'Error adding to cart' | json }}
        }
      </script>

    {% else %}
      <p>Product object is missing in this context.</p>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Main product (adapted)",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show thumbnails",
      "default": true
    },
    {
      "type": "text",
      "id": "color_text_title",
      "label": "Color label text",
      "default": "Виберіть колір:"
    },
    {
      "type": "text",
      "id": "size_text_title",
      "label": "Size label text",
      "default": "Виберіть розмір:"
    }
  ]
}
{% endschema %}
